---
title: 访问一个网页时的浏览器渲染过程
date: 2019-01-21 01:52:31
tags:
  - HTTP
  - 渲染原理
categories: HTTP
description: 深入理解前端常见面试题
---
### TCP/IP

[什么是TCP/IP?](./什么是TCP-IP.html)
TCP/IP 是供 **已连接因特网** 的计算机进行通信的 **通信协议** 

### DNS域名解析

[DNS解析过程](./DNS解析过程.html)  

1.  从本地域名服务器读取DNS缓存, 如果里面有则返回
2.  向根域名发起查询, 得到顶级域名服务器ip
3.  向顶级域名服务器发起查询, 得到域名服务器ip
4.  向域名服务器发起查询, 得到域名的ip, 缓存到本地并返回

### TCP连接

[TCP连接: 三次握手](./什么是TCP-IP.html#TCP连接与断开)
为了确保可靠性, TCP在建立连接前, 需要三次握手

1.  客户端发起连接请求
2.  服务端响应请求
3.  客户端确认发送请求, 建立TCP连接
建立TCP连接后, 客户端发送HTTP请求

### 浏览器缓存

浏览器的缓存有两个阶段: 

1.  强缓存阶段.
用户发送的请求，直接从客户端缓存中获取，不发送请求到服务器，不与服务器发生交互行为。
2.  协商缓存阶段
用户发送的请求，发送到服务器后，由服务器判定是否从缓存中获取资源。

#### 强缓存阶段

浏览器首先检查缓存文件的过期时间字段**Cache-Control: max-age**(HTTP/1.1) 和 **Expires**(HTTP/1.0), 来判断缓存文件是否过期, 两者都存在时优先使用Http/1.1的max-age。

*   如果未过期, 直接使用缓存文件, 此时浏览器的状态码为 200 (from disk cache) 或 200 OK (from memory cache)。
*   如果已过期, 进入协商缓存阶段

#### 协商缓存阶段

当浏览器需要和服务端确认缓存是否过期时, 会在请求头携带 If-Moified-Since 和 If-None-Match 字段, 服务端根据这两个字段判断资源是否被修改过

*   如果被修改过, 正常请求文件, 返回 200 状态码
*   如果没被修改过, 根据新的返回的响应头来设置缓存, 返回 304 状态码, 继续使用已过期但未被修改过的缓存文件

请求头与响应头中信息的对应关系:  

|请求头|响应头|说明|
|--|--|--|
|If-None-Match|(Etag)|文件的一个标记, 作用类似于hash|
|If-Moified-Since|(Last-Modified)|文件最后一次修改的时间|

与浏览器缓存控制相关的字段:
请求字段   

|指令|参数|说明|
|--|--|--|
|no-cache|(无)|强制源服务器再次验证|
|no-store|(无)|不缓存请求或是响应的任何内容|
|max-age=[秒]|(-)|缓存时长，单位是秒 缓存的时长，也是响应的最大的Age值|
|min-fresh=[秒]|(*)|期望在指定时间内响应仍然有效|
|no-transform|(无)|代理不可更改媒体类型|
|only-if-cached|(无)|从缓存获取|
|cache-extension|(-)|新的指令标记(token)|

响应字段
|指令|参数|说明|
|--|--|--|
|public|()|任意一方都能缓存该资源(客户端、代理服务器等)|
|private|(可省略)|只能特定用户缓存该资源|
|no-cache|(可省略)|缓存前必须先确认其有效性|
|no-store|()|不缓存请求或响应的任何内容|
|no-transform|()|代理不可更改媒体类型|
|must-revalidate|()|可缓存但必须再向源服务器进确认|
|proxy-revalidate|()|要求中间缓存服务器对缓存的响应有效性再进行确认|
|max-age=[秒]|(-)|缓存的时长，也是响应的最大的Age值|
|s-maxage=[秒]|(必需)|公共缓存服务器响应的最大Age值|
|cache-extension|(-)|新指令标记(token)|

### 浏览器解析渲染页面

1. 解析HTML，构建DOM树2.  解析CSS，生成CSS规则树
3. 合并DOM树和CSS规则，生成render树
4. 布局render树（Layout/reflow），负责各元素尺寸、位置的计算
5. 绘制render树（paint），绘制页面像素信息
> 页面自上而下渲染, 渲染script标签时, 会阻塞渲染进程(没有 defer 或 async 时)

### TCP 断开连接

[TCP断开: 四次握手](./什么是TCP-IP.html#TCP连接与断开)  